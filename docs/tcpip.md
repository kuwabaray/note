# TCP/IP

TCP/IPはprotocol familyの名前。主なプロトコルは以下。
- TCP
- IP
- UDP
- HTTP

サーバーのアプリケーションがsocket APIを介してTCPまたはUDPのサービスを使用する。TCP(UDP）はOSに実装されている。<br>
TCP(UDP)のサービスはのIPを使ってパケットの送受信を行う。<br>
```
パケット ... ネットワークで送受信される情報
プロトコル ... パケットの中身（内容）, パケット送受信の手順の規定
```
## TCP
パケットの消失や重複、送信順序の入替があった場合に送信元に再要求する。そのためアプリケーション側でパケットロスを考慮する必要がなく信頼性が高い。

### サーバー側の仕組み
```
1. ソケットを開き、接続を受け付けるIPアドレス・ポート番号をソケットに対応づける。
2. クライアントと接続を確立する。
3. 通信する（read(), write()）
4. ソケットを閉じる（close()）
```

#### 1. ソケットを開き、接続を受け付けるIPアドレス・ポート番号をソケットに対応づける。

IPアドレスでサーバーを特定でき、サーバーの各ポートとアプリケーションが使用しているソケットが紐づいているため、IPアドレスとポート番号で送信先を特定できる。
クライアントがhostのIPアドレスを知るにはDNS(domain name system)を使用するのが一般的。DNSサーバーに問い合わせてURLからIPアドレスに変換する。
ポート番号はURLから分からないので、~<br>
  
javaではserverSocketクラスのインスタンスを作成して、ローカルポートとバインドすることで受け付けられる状態にする。

#### 2. クライアントと接続を確立する。

新しいclient接続があるたびにaccept()によってsocketクラスのインスタンスを作成する。そのインスタンスから送信側のIPとport情報を取得できる。

3wayハンドシェイクといい、クライアント・サーバー間で3回接続の要求・確認を行うことで接続が確立される。

#### 3. 通信する（read(), write()）

write()で送信データ（バイト配列）をoutputStreamで送信側キューに書き込む。書き込んだデータは正常に送信完了するまで保持され、パケットロスなどがあれば再使用される。
flush()で送信する。
受信後、受信側のプログラムがread()をすると受信側キューにあるデータをinputStreamから読み込む。

flush()は送信側キューのデータを一度に送信し、read()は受信側キューのデータを一度に読み込む。
通知回数を減らすことでコストを下げている(Nagleアルゴリズム)。
これによって複数回write()したデータに対して1回のread()で読み込む場合や、
1回のwrite()で書き出したデータに対して複数回のread()で読み込む場合がある。
以下のような事象が起きる。対応としては1.区切り文字を入れる、または2.ヘッダーにメッセージのサイズを入れて固定長のヘッダを読んでからサイズに応じてボディを読み込む。
```
例：2回のwrite()で2個メッセージを送信したつもりだが、1回のread()で読み込まれ、くっついた1個のメッセージを取得した。
```
flush()は受信キューに空きがないとき完了しない。read()のループとwrite()のループを同じスレッドで実行している場合、通信をしているお互いの受信キューに空きがない状態でflush()を行うとデッドロックとなることに注意する。
### クライアント側の仕組み
```
1. ソケットを開き、接続するリモートIPアドレス・ポート番号でホスト側のソケットと接続する。
2. 通信を行なう (read(), write())
3. ソケットを閉じる (close())
```
## UDP
転送中に発生したsocketの破損等を検知し破棄する。それを考慮してアプリケーションを実装する必要がある。

UDPはTCPと異なり、送受信の前に接続を確立する必要がない。TCPはcloseするまで1つとしか送受信できないが、UDPは同時に複数の宛先と送受信ができる。
接続が必要ないことから少ないデータの送受信に適している。また送信内容を保証しないためバッファがいらないのでコストが低い。

UDPパケットはヘッダーにサイズの情報を持っており、1回のsend()に対して1回のrecieve()で受け取れるようになっている。

## 疑問
- 複数applicationが一つのsocketを参照するのはどういう場合か
- HTTP IPの違い

- それぞれのprotocolは~用のような目的があり作られている。
HTTP (Hyper Text Transfer Protocol): hyperTextで記述されたデータ(html形式など)をサーバー(application server)からbrowserに送信して表示させるため
getはまさにこれだけどpost deleteとかは？

## 参考資料
[1] Kenneth L. Calvert,Michael J. Donahoo,小高 知宏「TCP/IPソケットプログラミング Java編」<br>
[2] https://www.fos.kuis.kyoto-u.ac.jp/le2soft/siryo-html/node14.html<br>
